<body>
    <button id="requestbutton">REQUEST SHARE ID</button>
    <input id="inputbox">
    <button id="copybutton">copy id</button>
    <button id="startbutton">START SYNC!</button>
    <button id="testbutton">TEST PAUSE!</button>
    <button id="stopbutton">STOP SYNC!</button>

    <script>
        const requestbutton = document.getElementById("requestbutton")
        const copybutton = document.getElementById("copybutton")
        const startbutton = document.getElementById("startbutton")
        const testbutton = document.getElementById("testbutton")
        const stopbutton = document.getElementById("stopbutton")
        const inputbox = document.getElementById("inputbox");
        var websocket;

        copybutton.addEventListener("click", e =>{
            e.preventDefault();
            copyToClipboard(e)
        })

        requestbutton.addEventListener("click", e =>{
            e.preventDefault();
            handleCreateHostSession(e)
        })

        startbutton.addEventListener("click", e =>{
            e.preventDefault();
            handleBeginSessions(e)
        })

        

        function handleCreateHostSession(e){
            e.preventDefault();
            let url = 'http://localhost:3000/v1/session'
            fetch(url,{
                method: 'GET',          
                }).then(res => {
                    if (res.status < 300) {
                        return res.json();
                    }
                    return res.text();
                }).then(data => {
                console.log(data);
                sessionPair = JSON.parse(JSON.stringify(data));
                if(sessionPair != null){
                    inputbox.value = sessionPair.selfID;
                }
            })
        }

        function copyToClipboard(e){
            e.preventDefault();
            let url = `ws://localhost:3000/ws/?id=${inputbox.value}`
            inputbox.select();
            document.execCommand("copy");
            alert("copied the text: " + inputbox.value + " to clipboard");     
            
            var websocket = new WebSocket(url);
            websocket.onmessage = (event) => {
            console.log(`RECEIVED ${event.data}`);
            }
            handleOnSessions(e, websocket)
        }

        function handleBeginSessions(e){
            e.preventDefault();
            let url = `http://localhost:3000/v1/session/?id=${inputbox.value}`
            fetch(url,{
                method: 'GET',          
                }).then(res => {
                    if (res.status < 300) {
                        return res.json();
                    }
                    return res.text();
                }).then(data => {
                console.log(data);
                sessionPair = JSON.parse(JSON.stringify(data));
                if(sessionPair != null){
                    inputbox.value = sessionPair.selfID;
                }
                var websocket = new WebSocket(`ws://localhost:3000/ws/?id=${sessionPair.selfID}`);
                websocket.onmessage = (msg) => {
                    console.log(`RECEIVED ${msg.data}`);
                    if(msg.data == "-1"){
                        alert("socket connection closed by other partner");
                        console.log("socket connection closed by other partner");
                        return
                    } else if(msg.data == "-2"){
                        alert("not connected to other partner");
                        return
                    }
                }
                handleOnSessions(e, websocket)
            })
        }

        function handleOnSessions(e, websocket){
            stopbutton.addEventListener("click", e =>{
                    e.preventDefault();
                    function isOpen(websocket) { return websocket.readyState === websocket.OPEN }
                    websocket.close();
                    return
                 })

                testbutton.addEventListener("click", ev =>{
                    ev.preventDefault();
                    function isOpen(websocket) { return websocket.readyState === websocket.OPEN }
                    if (isOpen(websocket)){
                        console.log(`SENDING PAUSE`);
                        websocket.send('1');
                    }
                })
        }
    </script>
</body>